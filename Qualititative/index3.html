<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Vibrant.js example</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="libraries/vibrant.js"></script>
 
  </head>
  <style>
    #infoPopup {
    position: fixed;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    background-color: white;
    border: 1px solid #ddd;
    padding: 20px;
    z-index: 1000;
}

  </style>
  <body>
    <div id="Typefilter">
      <button class="artTypeButton" data-art-type="all">All</button>
      <button class="artTypeButton" data-art-type="sculpture">Sculpture</button>
      <button class="artTypeButton" data-art-type="painting">Painting</button>
      <button class="artTypeButton" data-art-type="decorative art">Decorative Art</button>
    </div>

    <div id="color_filters">
      <input type="color" class="color-picker">
      <input type="color" class="color-picker">
      <input type="color" class="color-picker">
      <input type="color" class="color-picker">
      <input type="color" class="color-picker">
  </div>
    <div id="image_container"></div>

    <div id="infoPopup" style="display: none;">
      <!-- infomation in popup -->
      <div id="infoContent"></div>
      <button onclick="closePopup()">Close</button>
  </div>
  
    
    <script>
      function isColorSimilar(hex1, hex2) {
          let threshold = 40;
          let rgb1 = hexToRgb(hex1);
          let rgb2 = hexToRgb(hex2);

          let diffR = Math.abs(rgb1.r - rgb2.r);
          let diffG = Math.abs(rgb1.g - rgb2.g);
          let diffB = Math.abs(rgb1.b - rgb2.b);

          return diffR <= threshold && diffG <= threshold && diffB <= threshold;
        }

        // Function to convert hex to RGB
        function hexToRgb(hex) {
          let bigint = parseInt(hex.slice(1), 16);
          return {
            r: (bigint >> 16) & 255,
            g: (bigint >> 8) & 255,
            b: bigint & 255
          };
        }

        // Event listener for color picker changes
        function handleColorPickerEvent(event) {
          const currentColor = event.target.value;
          const selectedType = document.getElementById('artTypeDropdown').value;
          
          filterDotsByArtTypeAndColor(selectedType, currentColor);
      }
      

        // Adding color picker event listeners
        for (let i = 1; i <= 5; i++) {
          const colorPicker = document.getElementById(`colorPicker${i}`);
          if (colorPicker) {
            colorPicker.addEventListener('input', handleColorPickerEvent);
          } else {
            console.error(`colorPicker${i} is missing from the DOM.`);
          }
        }

        // Function to clear a color box
        window.clearBoxColor = function(boxNumber) {
          document.getElementById(`box${boxNumber}`).style.backgroundColor = '';
          document.getElementById(`colorPicker${boxNumber}`).value = "#ffffff";

          if (boxNumber === 1) {
            for (let i = 2; i <= 5; i++) deleteBox(i);
          }
        };

        // Function to delete a color box
  window.deleteBox = function(boxNumber) {
    for (let i = boxNumber; i <= 5; i++) {
      document.getElementById(`box${i}`).style.display = 'none';
      document.getElementById(`box${i}`).style.backgroundColor = '';
      document.getElementById(`colorPicker${i}`).value = "#ffffff";
    }
  };

  // Function to add a color box
  window.addColorBox = function() {
    if (document.getElementById(`box${currentBoxCount}`).style.backgroundColor !== "" && (currentBoxCount < 5)) {
      currentBoxCount++;
      document.getElementById('box' + currentBoxCount).style.display = 'block';
    } else {
      alert('Please add color');
    }
  };
  


        // Initial box count
        let currentBoxCount = 1;

        // Create color picker boxes
        function createColorPickerBoxes() {
          document.querySelectorAll(".box").forEach(box => {
            document.body.appendChild(box);
          });
        }

       
        function updateCombinedColorDisplay() {
          let selectedColors = [];
          for (let i = 1; i <= 5; i++) {
            let color = document.getElementById(`box${i}`).style.backgroundColor;
            if (color) selectedColors.push(color);
          }
      
          document.getElementById('combinedColorDisplay').style.background = selectedColors.length >= 2 ?
            `linear-gradient(to top, ${selectedColors.join(',')})` :
            (selectedColors.length === 1 ? selectedColors[0] : '');
        }
      
        // Function to update the stacked color boxes
        function updateStackedColorBox() {
          let stackedColors = [];
          for (let i = 1; i <= 5; i++) {
            let color = document.getElementById(`box${i}`).style.backgroundColor;
            if (color) stackedColors.push(color);
          }
      
          for (let i = 1; i <= 5; i++) {
            document.getElementById(`stackedBox${i}`).style.backgroundColor = stackedColors[i - 1] || 'transparent';
          }
        }
      
        // Adding event listeners for each color picker
        for (let i = 1; i <= 5; i++) {
          const colorPicker = document.getElementById(`colorPicker${i}`);
          if (!colorPicker) {
            console.error(`colorPicker${i} is missing from the DOM.`);
            continue;
          }
          colorPicker.addEventListener('input', event => {
            document.getElementById(`box${i}`).style.backgroundColor = event.target.value;
            updateCombinedColorDisplay();
            updateStackedColorBox();
          });
        }

// 
const colors = [];
const selectedColors = [];

function getColorByArtType(TypesofArt) {
    switch (TypesofArt) {
        case 'sculpture':
            return 'red';
        case 'painting':
            return 'blue';
        case 'decorative art':
            return 'green';
    }
}

function colorDifference(color1, color2) {
    const r1 = parseInt(color1.slice(1, 3), 16);
    const g1 = parseInt(color1.slice(3, 5), 16);
    const b1 = parseInt(color1.slice(5, 7), 16);

    const r2 = parseInt(color2.slice(1, 3), 16);
    const g2 = parseInt(color2.slice(3, 5), 16);
    const b2 = parseInt(color2.slice(5, 7), 16);

    const dr = r1 - r2;
    const dg = g1 - g2;
    const db = b1 - b2;

    return Math.sqrt(dr * dr + dg * dg + db * db);
}

function filterBySelectedColors() {
    const tolerance = 50;

    if (selectedColors.length === 0) {
        d3.selectAll('.img-container').style('display', 'block');
        return;
    }

    d3.selectAll('.img-container').style('display', function() {
        const circleColor = d3.select(this).select('circle').attr('data-color').toUpperCase();
        for (let i = 0; i < selectedColors.length; i++) {
            if (colorDifference(circleColor, selectedColors[i]) < tolerance) {
                return 'block';
            }
        }
        return 'none';
    });
}

d3.csv('data.csv').then(function(data) {
    data.slice(0, 1000).forEach(function(d, index) {
        const imgContainer = d3.select('#image_container')
            .append('svg')
            .attr('class', 'img-container')
            .attr('id', 'img-container-' + index)
            .attr('width', 100)
            .attr('height', 100)
            .attr('data-art-type', d.TypesofArt);

        Vibrant.from(d.iiifthumburl).getPalette(function(err, palette) {
            if (!err) {
                for (var swatch in palette) {
                    if (palette[swatch] && typeof palette[swatch].getHex === 'function') {
                        const hexColor = palette[swatch].getHex();
                        colors.push(hexColor);

                        imgContainer.append("circle")
                            .attr('cx', 50)
                            .attr('cy', 50)
                            .attr('r', 10)
                            .attr('fill', getColorByArtType(d.TypesofArt))
                            .attr('data-color', hexColor)
                            .attr('data-art-type', d.TypesofArt);
                    }
                }
                imgContainer.on('click', function() {
                    showModal(d.iiifthumburl, "Some info", colors);
                });
            }
        });
    });
});



d3.select("#artTypeFilter").on("change", function() {
    filterArtByType(this.value);
});

function filterArtByType(type) {
    if (type === "all") {
        d3.selectAll(".img-container").style("display", "block");
        return;
    }

    d3.selectAll(".img-container").style("display", "none");
    d3.selectAll(`.img-container[data-art-type='${type}']`).style("display", "block");
}
document.querySelectorAll('.artTypeButton').forEach(button => {
    button.addEventListener('click', function() {
        filterArtByType(this.getAttribute('data-art-type'));
    });
});


d3.selectAll('.color-picker').on('input', function() {
    const selectedColor = this.value.toUpperCase();
    if (!selectedColors.includes(selectedColor)) {
        selectedColors.push(selectedColor);
    }
    filterBySelectedColors();
});

//Click for more information
function showPopup(info) {
    document.getElementById('infoContent').innerHTML = info; // 'info' = ifo to show
    document.getElementById('infoPopup').style.display = 'block';
}

function closePopup() {
    document.getElementById('infoPopup').style.display = 'none';
}


    </script>
  </body>
</html>